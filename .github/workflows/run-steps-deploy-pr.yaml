name: Gerar tag e realizar deploy

on:
  pull_request:
    types:
      - closed

jobs:
  deployment:
    runs-on: ubuntu-latest

    env:
      NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
      NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
      NEXUS_HOST: ${{ secrets.NEXUS_HOST }}

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v2

      - name: Configurar ambiente
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: "npm"

      - name: Instalar dependÃªncias
        run: npm install --legacy-peer-deps

      - name: Configurar gcloud
        uses: google-github-actions/setup-gcloud@v0.3.0
        with:
          project_id: ${{ secrets.GCLOUD_PROJECT_ID }}
          service_account_key: ${{ secrets.GCLOUD_SERVICE_KEY }}
          export_default_credentials: true

      - name: Gerar Tag
        if: github.event.pull_request.merged == true
        run: |
          # ObtÃ©m a versÃ£o do application.properties
          VERSION=$(node -p "require('./package.json').version")

          # Gerar uma tag com a versÃ£o do application.properties
          git tag $VERSION
          git push origin $VERSION

      - name: Logar no Nexus
        if: github.event.pull_request.merged == true
        run: npm login --registry=http://${NEXUS_HOST}/repository/npm-conatus-sa/ -u ${{ secrets.NEXUS_USERNAME }} -p ${{ secrets.NEXUS_PASSWORD }}

      - name: Publicar pacote NPM no Nexus
        if: github.event.pull_request.merged == true
        run: npm publish --registry=http://${NEXUS_HOST}/repository/npm-conatus-sa/

      - name: Deslogar do Nexus
        if: github.event.pull_request.merged == true
        run: npm logout --registry=http://${NEXUS_HOST}/repository/npm-conatus-sa/

      - name: Comentar no PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ O Pull Request foi implantado com sucesso no ambiente'
            })
